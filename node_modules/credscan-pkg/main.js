const path = require('path');
const edge = require('edge-js');
const core = require('@actions/core');

var version = 'core'
var namespace = 'QuickStart.' + version.charAt(0).toUpperCase() + version.substr(1);
if (version === 'core') version = 'coreapp';

const baseNetAppPath = path.join(__dirname, '/src/' + namespace + '/bin/Debug/net' + version + '2.0');

process.env.EDGE_USE_CORECLR = 1;
if (version !== 'standard')
    process.env.EDGE_APP_ROOT = baseNetAppPath;

var baseDll = path.join(baseNetAppPath, namespace + '.dll');

var localTypeName = namespace + '.LocalMethods';

var credScanFunction = edge.func({
    assemblyFile: baseDll,
    typeName: localTypeName,
    methodName: 'Invoke'
});

async function credscan(input, scannedResult){
  return credScanFunction(input, function (error, result) {
    if (error) throw error;
    if (input.toString() !== result.toString()) {
      core.warning('Credentials were found.');
    }
    let strinput = input.toString();
    let strlen = strinput.length;
    if (strinput[strlen - 1] == 0) return input;
    scannedResult.result = result;
    return result;
  })
}


const credscan_no_warning = (input) => credScanFunction(input, function(error, result) {
    if (error) throw error;
    console.log(result);
    return result;
});

module.exports = { credscan, credscan_no_warning };
